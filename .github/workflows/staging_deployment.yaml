name: Staging deployment

on: [pull_request]

jobs:
  deploy:
    name: Deploy Preview
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: false
          lfs: true

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: wasm32-unknown-unknown

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: 'npm'
          cache-dependency-path: www/package-lock.json

      - name: Install cargo-binstall
        uses: cargo-bins/cargo-binstall@main

      - name: Install wasm-pack
        run: cargo binstall wasm-pack --version 0.14.0 --no-confirm --force

      - name: Install and Build
        run: |
          cd www
          npm ci
          npm run build

      - name: Deploy to Netlify
        id: netlify
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          npm install -g netlify-cli
          
          OUTPUT=$(netlify deploy \
            --dir=www/dist \
            --site="$NETLIFY_SITE_ID" \
            --auth="$NETLIFY_AUTH_TOKEN" \
            --message="PR #${{ github.event.number }}: ${{ github.event.pull_request.title }}" \
            --json)
          
          DEPLOY_URL=$(echo "$OUTPUT" | jq -r '.deploy_url')
          echo "deploy_url=$DEPLOY_URL" >> $GITHUB_OUTPUT
        timeout-minutes: 5

      - name: Comment PR with preview URL
        uses: actions/github-script@v7
        with:
          script: |
            const deployUrl = '${{ steps.netlify.outputs.deploy_url }}';
            const body = `## ðŸš€ Deploy Preview\n\n**URL:** ${deployUrl}\n\n_Commit: ${{ github.event.pull_request.head.sha }}_`;
            
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(c => 
              c.user.type === 'Bot' && c.body.includes('Deploy Preview')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
